{% extends "admin/base.html" %}

{% block title %}修改密码 - 后台管理{% endblock %}
{% block page_title %}系统设置 / 修改密码{% endblock %}

{% block content %}
<div id="app" class="content-body" v-cloak>
    
    <div class="password-layout-card">
        
        <div class="security-banner">
            <div class="banner-content">
                <div class="icon-circle">
                    <i class="ri-shield-keyhole-fill"></i>
                </div>
                <h3>账号安全中心</h3>
                <p>为了您的账号安全，建议定期更换密码。<br>请使用包含字母、数字和符号的强密码组合。</p>
                
                <div class="security-tips">
                    <div class="tip-item"><i class="ri-check-line"></i> 不使用与其他网站相同的密码</div>
                    <div class="tip-item"><i class="ri-check-line"></i> 长度至少 6 位以上</div>
                    <div class="tip-item"><i class="ri-check-line"></i> 定期检查登录记录</div>
                </div>
            </div>
            <div class="bg-circle c1"></div>
            <div class="bg-circle c2"></div>
        </div>

        <div class="form-container">
            <div class="form-header">
                <h2>修改登录密码</h2>
                <span class="sub-text">请填写下方的表单来更新您的凭证</span>
            </div>

            <transition name="fade">
                <div class="alert-box error" v-if="errorMessage">
                    <i class="ri-error-warning-fill"></i> ${ errorMessage }
                </div>
            </transition>
            <transition name="fade">
                <div class="alert-box success" v-if="successMessage">
                    <i class="ri-checkbox-circle-fill"></i> ${ successMessage }
                </div>
            </transition>

            <form @submit.prevent="submitForm" class="password-form">
                <div class="form-group">
                    <label>当前旧密码</label>
                    <div class="input-wrapper">
                        <input :type="showOld ? 'text' : 'password'" v-model="form.old_password" placeholder="验证当前密码" required>
                        <i class="eye-btn" :class="showOld ? 'ri-eye-line' : 'ri-eye-off-line'" @click="showOld = !showOld"></i>
                    </div>
                </div>

                <div class="form-group">
                    <label>新密码</label>
                    <div class="input-wrapper">
                        <input :type="showNew ? 'text' : 'password'" v-model="form.new_password" placeholder="设置新密码" required>
                        <i class="eye-btn" :class="showNew ? 'ri-eye-line' : 'ri-eye-off-line'" @click="showNew = !showNew"></i>
                    </div>
                    <div class="password-strength" v-if="form.new_password">
                        <div class="strength-bar" :style="{ width: strengthScore + '%', background: strengthColor }"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>确认新密码</label>
                    <div class="input-wrapper">
                        <input :type="showConfirm ? 'text' : 'password'" v-model="form.confirm_password" placeholder="再次输入新密码" required>
                        <i class="eye-btn" :class="showConfirm ? 'ri-eye-line' : 'ri-eye-off-line'" @click="showConfirm = !showConfirm"></i>
                    </div>
                    <div class="validation-msg" v-if="form.confirm_password && form.new_password !== form.confirm_password">
                        <i class="ri-close-circle-fill"></i> 两次输入的密码不一致
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-submit" :disabled="loading || !isFormValid">
                        <span v-if="loading"><i class="ri-loader-4-line spin-icon"></i> 提交中...</span>
                        <span v-else>确认修改密码</span>
                    </button>
                    <button type="button" class="btn-reset" @click="resetForm">重置</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block head_extra %}
<style>
    [v-cloak] { display: none; }

    /* === 整体布局 === */
    .content-body {
            display: flex;
    justify-content: center;
    align-items: center;
    padding-top: 40px;
    }

    .password-layout-card {
        width: 100%; /* 加宽 */
        max-width: 95%;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        display: flex;
        overflow: hidden;
        min-height: 550px; /* 保证高度 */
    }

    /* === 左侧：安全Banner === */
    .security-banner {
        width: 40%;
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: white;
        padding: 60px 40px;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
    }

    .banner-content { position: relative; z-index: 2; }

    .icon-circle {
        width: 64px; height: 64px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 32px;
        margin-bottom: 24px;
        backdrop-filter: blur(10px);
    }

    .security-banner h3 { font-size: 24px; margin-bottom: 16px; font-weight: 600; letter-spacing: 0.5px; }
    .security-banner p { font-size: 14px; line-height: 1.6; opacity: 0.9; margin-bottom: 40px; }

    .security-tips .tip-item { display: flex; align-items: center; gap: 10px; font-size: 13px; margin-bottom: 12px; opacity: 0.8; }
    .security-tips .tip-item i { color: #60a5fa; background: rgba(255,255,255,0.1); padding: 4px; border-radius: 50%; }

    /* 装饰圆 */
    .bg-circle { position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.05); z-index: 1; }
    .c1 { width: 300px; height: 300px; top: -100px; right: -100px; }
    .c2 { width: 200px; height: 200px; bottom: -50px; left: -50px; }

    /* === 右侧：表单区 === */
    .form-container {
        width: 60%;
        padding: 60px 80px; /* 宽敞的内边距 */
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .form-header { margin-bottom: 30px; }
    .form-header h2 { font-size: 24px; color: #1e293b; margin-bottom: 8px; font-weight: 700; }
    .sub-text { color: #64748b; font-size: 14px; }

    /* 表单控件 */
    .form-group { margin-bottom: 24px; }
    .form-group label { display: block; font-size: 14px; font-weight: 600; color: #334155; margin-bottom: 8px; }

    .input-wrapper { position: relative; }
    .input-wrapper input {
        width: 100%;
        height: 48px; /* 增高 */
        padding: 0 45px 0 16px;
        border: 2px solid #f1f5f9; /* 加粗边框 */
        border-radius: 10px;
        font-size: 15px;
        color: #1e293b;
        transition: all 0.3s;
        box-sizing: border-box;
        background: #f8fafc;
    }
    .input-wrapper input:focus { border-color: #2563eb; background: #fff; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); outline: none; }
    .input-wrapper input::placeholder { color: #cbd5e1; }

    .eye-btn {
        position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
        color: #94a3b8; cursor: pointer; font-size: 18px; padding: 5px;
        transition: color 0.2s;
    }
    .eye-btn:hover { color: #2563eb; }

    /* 强度条 */
    .password-strength { height: 4px; background: #f1f5f9; border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .strength-bar { height: 100%; transition: all 0.3s; }

    /* 验证消息 */
    .validation-msg { color: #ef4444; font-size: 13px; margin-top: 8px; display: flex; align-items: center; gap: 6px; font-weight: 500; }

    /* 按钮组 */
    .form-actions { margin-top: 40px; display: flex; gap: 15px; }
    
    .btn-submit {
        flex: 1;
        height: 48px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    .btn-submit:hover:not(:disabled) { background: #1d4ed8; transform: translateY(-1px); box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3); }
    .btn-submit:disabled { background: #93c5fd; cursor: not-allowed; box-shadow: none; }

    .btn-reset {
        width: 100px;
        height: 48px;
        background: white;
        border: 2px solid #e2e8f0;
        color: #64748b;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-reset:hover { border-color: #cbd5e1; color: #334155; background: #f8fafc; }

    /* 提示条 */
    .alert-box { padding: 14px 18px; border-radius: 10px; margin-bottom: 25px; font-size: 14px; display: flex; align-items: center; gap: 10px; font-weight: 500; }
    .alert-box.error { background: #fef2f2; color: #ef4444; border: 1px solid #fee2e2; }
    .alert-box.success { background: #ecfdf5; color: #10b981; border: 1px solid #d1fae5; }

    /* 动画 */
    .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
    .fade-enter, .fade-leave-to { opacity: 0; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spin-icon { animation: spin 1s linear infinite; }

    /* 响应式：手机端变回单栏 */
    @media (max-width: 900px) {
        .content-body{
            padding: 10px 0px;
        }
        
        .password-layout-card { flex-direction: column-reverse; width: 100%; height: auto; }
        .security-banner { width: 100%; padding: 40px 30px; min-height: 200px; }
        .form-container { width: 100%; padding: 40px 30px; }
        .bg-circle { display: none; } /* 手机上简化背景 */
    }
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/vue.js') }}"></script>
<script>
    new Vue({
        el: '#app',
        delimiters: ['${', '}'],
        data: {
            form: {
                old_password: '',
                new_password: '',
                confirm_password: ''
            },
            showOld: false, showNew: false, showConfirm: false,
            loading: false, errorMessage: '', successMessage: ''
        },
        computed: {
            isFormValid() {
                return this.form.old_password && 
                       this.form.new_password && 
                       this.form.confirm_password &&
                       this.form.new_password === this.form.confirm_password;
            },
            // 计算密码强度分 (0-100)
            strengthScore() {
                const p = this.form.new_password;
                if (!p) return 0;
                let score = 0;
                if (p.length > 6) score += 30;
                if (/[A-Z]/.test(p)) score += 20; // 有大写
                if (/[0-9]/.test(p)) score += 20; // 有数字
                if (/[^A-Za-z0-9]/.test(p)) score += 30; // 有符号
                return Math.min(100, score);
            },
            strengthColor() {
                if (this.strengthScore < 40) return '#ef4444'; // 红
                if (this.strengthScore < 80) return '#f59e0b'; // 橙
                return '#10b981'; // 绿
            }
        },
        methods: {
            async submitForm() {
                if (!this.isFormValid) return;
                this.loading = true;
                this.errorMessage = '';
                this.successMessage = '';

                try {
                    const response = await fetch('/admin/change-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.form)
                    });
                    const result = await response.json();
                    
                    if (response.ok) {
                        this.successMessage = result.message;
                        setTimeout(() => { window.location.href = '/login'; }, 2000);
                    } else {
                        this.errorMessage = result.message;
                    }
                } catch (error) {
                    this.errorMessage = '网络请求失败，请检查连接';
                } finally {
                    this.loading = false;
                }
            },
            resetForm() {
                this.form = { old_password: '', new_password: '', confirm_password: '' };
                this.errorMessage = '';
                this.successMessage = '';
            }
        }
    });
</script>
{% endblock %}